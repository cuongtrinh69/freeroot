#!/bin/sh

#############################
# Ubuntu RootFS Installer   #
#############################

ROOTFS_DIR=/home/container
UBUNTU_VERSION="focal"  # tương ứng với 20.04
PROOT_VERSION="5.3.0"

ARCH=$(uname -m)

if [ "$ARCH" = "x86_64" ]; then
  ARCH_ALT=amd64
  PROOT_URL="https://github.com/proot-me/proot/releases/download/v${PROOT_VERSION}/proot-v${PROOT_VERSION}-x86_64-static"
  ROOTFS_URL="http://partner-images.canonical.com/core/${UBUNTU_VERSION}/current/ubuntu-${UBUNTU_VERSION}-core-cloudimg-${ARCH_ALT}-root.tar.gz"
elif [ "$ARCH" = "aarch64" ]; then
  ARCH_ALT=arm64
  PROOT_URL="https://github.com/proot-me/proot/releases/download/v${PROOT_VERSION}/proot-v${PROOT_VERSION}-aarch64-static"
  ROOTFS_URL="http://partner-images.canonical.com/core/${UBUNTU_VERSION}/current/ubuntu-${UBUNTU_VERSION}-core-cloudimg-${ARCH_ALT}-root.tar.gz"
else
  echo "Unsupported architecture: $ARCH"
  exit 1
fi

if [ ! -e $ROOTFS_DIR/.installed ]; then
    echo "[+] Đang tải Ubuntu core rootfs..."
    curl -Lo /tmp/rootfs.tar.gz "$ROOTFS_URL"
    mkdir -p $ROOTFS_DIR
    tar -xzf /tmp/rootfs.tar.gz -C $ROOTFS_DIR
    mkdir -p $ROOTFS_DIR/root
fi

if [ ! -e $ROOTFS_DIR/usr/local/bin/proot ]; then
    echo "[+] Tải proot..."
    mkdir -p $ROOTFS_DIR/usr/local/bin
    curl -Lo $ROOTFS_DIR/usr/local/bin/proot "$PROOT_URL"
    chmod 755 $ROOTFS_DIR/usr/local/bin/proot
fi

if [ ! -e $ROOTFS_DIR/.installed ]; then
    echo "[+] Cấu hình DNS..."
    echo "nameserver 1.1.1.1" > $ROOTFS_DIR/etc/resolv.conf
    echo "nameserver 1.0.0.1" >> $ROOTFS_DIR/etc/resolv.conf
    rm -rf /tmp/rootfs.tar.gz
    touch $ROOTFS_DIR/.installed
fi

clear && cat << EOF

███████  ██████   ██████   ███████  ██████   ███████  ███████ ████████
██       ██   ██  ██   ██  ██       ██   ██  ██   ██  ██   ██    ██
█████    ██████   ██████   ██████   ██████   ██   ██  ██   ██    ██
██       ██   ██  ██   ██  ██       ██   ██  ██   ██  ██   ██    ██
██       ██   ██  ██   ██  ███████  ██   ██  ███████  ███████    ██

 
Chào mừng đến với Ubuntu 20.04 freerootmini!
Đây là môi trường Ubuntu nhẹ chạy không cần quyền root, phù hợp cho các tác vụ lập trình, học tập và chạy ứng dụng thực tế.

Sau đây là một số lệnh hữu ích để bạn bắt đầu:
    apt update
    apt install bash curl nano wget python3

EOF

$ROOTFS_DIR/usr/local/bin/proot \
--rootfs="${ROOTFS_DIR}" \
--link2symlink \
--kill-on-exit \
--root-id \
--cwd=/root \
--bind=/proc \
--bind=/dev \
--bind=/sys \
--bind=/tmp \
--bind=/etc/resolv.conf \
/bin/sh
