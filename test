#!/bin/sh

#############################
# Ubuntu RootFS Installer   #
#############################

ROOTFS_DIR=/home/container

UBUNTU_VERSION="20.04"
PROOT_VERSION="5.3.0"

ARCH=$(uname -m)

if [ "$ARCH" = "x86_64" ]; then
  ARCH_ALT=amd64
  PROOT_URL="https://github.com/proot-me/proot/releases/download/v${PROOT_VERSION}/proot-v${PROOT_VERSION}-x86_64-static"
elif [ "$ARCH" = "aarch64" ]; then
  ARCH_ALT=arm64
  PROOT_URL="https://github.com/proot-me/proot/releases/download/v${PROOT_VERSION}/proot-v${PROOT_VERSION}-aarch64-static"
else
  printf "Unsupported CPU architecture: ${ARCH}"
  exit 1
fi

# Bước 1: Tải rootfs nếu chưa có
if [ ! -e $ROOTFS_DIR/.installed ]; then
    echo "[+] Đang tải Ubuntu $UBUNTU_VERSION rootfs..."
    curl -Lo /tmp/rootfs.tar.gz \
    "http://cdimage.ubuntu.com/ubuntu-base/releases/${UBUNTU_VERSION}/release/ubuntu-base-${UBUNTU_VERSION}-base-${ARCH_ALT}.tar.gz"
    mkdir -p $ROOTFS_DIR
    tar -xzf /tmp/rootfs.tar.gz -C $ROOTFS_DIR
fi

################################
# Tải PRoot vào thư mục riêng  #
################################

if [ ! -e $ROOTFS_DIR/usr/local/bin/proot ]; then
    echo "[+] Tải proot..."
    mkdir -p $ROOTFS_DIR/usr/local/bin
    curl -Lo $ROOTFS_DIR/usr/local/bin/proot "$PROOT_URL"
    chmod 755 $ROOTFS_DIR/usr/local/bin/proot
fi

####################################
# Cài đặt bổ sung và dọn dẹp tạm   #
####################################

if [ ! -e $ROOTFS_DIR/.installed ]; then
    echo "[+] Cấu hình DNS..."
    printf "nameserver 1.1.1.1\nnameserver 1.0.0.1" > ${ROOTFS_DIR}/etc/resolv.conf
    echo "[+] Dọn dẹp file tạm..."
    rm -rf /tmp/rootfs.tar.gz
    touch $ROOTFS_DIR/.installed
fi

################################
# Thông báo chào mừng người dùng #
################################

clear && cat << EOF

███████  ██████   ██████   ███████  ██████   ███████  ███████ ████████
██       ██   ██  ██   ██  ██       ██   ██  ██   ██  ██   ██    ██
█████    ██████   ██████   ██████   ██████   ██   ██  ██   ██    ██
██       ██   ██  ██   ██  ██       ██   ██  ██   ██  ██   ██    ██
██       ██   ██  ██   ██  ███████  ██   ██  ███████  ███████    ██

 
Chào mừng đến với Ubuntu $UBUNTU_VERSION freerootmini!
Đây là môi trường Ubuntu nhẹ chạy không cần quyền root, phù hợp cho các tác vụ lập trình, học tập và chạy ứng dụng thực tế.

Sau đây là một số lệnh hữu ích để bạn bắt đầu:

    apt update : cập nhật danh sách gói
    apt install [gói] : cài đặt một gói phần mềm
    apt upgrade : nâng cấp các gói đã cài
    apt search [gói] : tìm kiếm gói
    apt remove [gói] : xoá gói

Đã Việt hoá thân thiện để bạn sử dụng dễ dàng hơn!

EOF

###########################
# Bắt đầu môi trường PRoot #
###########################

$ROOTFS_DIR/usr/local/bin/proot \
--rootfs="${ROOTFS_DIR}" \
--link2symlink \
--kill-on-exit \
--root-id \
--cwd=/root \
--bind=/proc \
--bind=/dev \
--bind=/sys \
--bind=/tmp \
--bind=/etc/resolv.conf \
/bin/bash
